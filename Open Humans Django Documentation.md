# Open Humans Django Documentation
## Open Humans Project configuration 
More can be read regarding setting up an OAuth project on the OpenHumans.org website. However, it is key to note that the redirect url that `django-open-humans` uses is 

`<base_url>/openhumans/complete`

![](Open%20Humans%20Django%20Documentation/42076CB1-A084-45C2-A353-489DD33D8B48.png)

## OH Module Configuration 
### OH Environment Configurations

Configuration for the Open Humans plugin is held in environment variables. In Python this is done by having a `.env` file in the root directory.

```python
OPENHUMANS_CLIENT_ID=<CLIENT_ID>
OPENHUMANS_CLIENT_SECRET=<SECRECT_ID>
OPENHUMANS_APP_BASE_URL=http://localhost:8000/
```

### Settings.py

The following code snippet reads the environment variable set up in the previous section.  _(Second argument provides a default value in the event that the environment variable is not set)_

`File: settings.py`
```python
# Open Humans settings
OPENHUMANS_APP_BASE_URL = os.getenv(
    'OPENHUMANS_APP_BASE_URL', 'http://localhost:5000')
OPENHUMANS_CLIENT_ID = os.getenv('OPENHUMANS_CLIENT_ID', 'your_client_id')
OPENHUMANS_CLIENT_SECRET = os.getenv(
    'OPENHUMANS_CLIENT_SECRET', 'your_client_secret')
```
 _This requires the python-dotenv package:_

1. `pip install python-dotenv`

2. `from dotenv import load_dotenv`

### urls.py

`File urls.py -> main_app`
```python
...
urlpatterns += [
    path('openhumans/', include('openhumans.urls')),
]
...
```
These additional login patterns are required by `django-open-humans`.

## Database Configurations
It is important to run the Django migrate database function in order to set up our OpenHumans Database Tables

This can be done with:

`python manage.py migrate`

From the project root.

## Login Mechanics### Custom login routes for the Prototype:

`File: urls.py -> skeleton -> urlpatterns []`
```python
...
url(r'^login/?$', views.login, name='login'),
url(r'^logout/?$', views.logout_user, name='logout'),
...
```

### Login auth URL:
`File: templates/navbar.html `
```html
<li class="nav-item">
    {% if not oh_id %}
        <a href="{{ auth_url }}" class="nav-link m-2 menu-item">Login</a>
    {% endif %}
    {% if oh_id %}
        <a href="/logout" class="nav-link m-2 menu-item">Logout</a>
    {% endif %}
</li>

```
`auth_url` _holds the url that redirects to the open-humans login page. This is specific to your app and based upon the key configuration_

## OAuth Flow
After initiating the login sequence the Django app redirects you to the openhumans.org webpage: 
![](Open%20Humans%20Django%20Documentation/A6A2B724-3759-4AD5-89B1-F5FBF9888DFF.png)
Where you are asked for credentials.

The next step is the authorise the app to use the open humans service, and access the data of the user that is logging in.
![](Open%20Humans%20Django%20Documentation/4E595731-41C8-4049-B42C-1A3890462289.png)
The permissions that the application is requesting are listed on the page .

After the user authorises the application, they are returned to the Django app with access tokens. These access tokens allow the application to access the open humans service from the users account _without_ the need for the users credentials to be known to the system.

## View Context
The application utilises a context dictionary which is passed around the different views. 
`File: views.py -> componentGallery()`
```python
auth_url = OpenHumansMember.get_auth_url()
context = {**context, **{'auth_url': auth_url,
                         'oh_proj_page': settings.OH_PROJ_PAGE}}
if request.user.is_authenticated:
    oh_member = request.user.openhumansmember
    context = {**context, **{'oh_id': oh_member.oh_id,
                             'oh_member': oh_member,
                             'oh_proj_page': settings.OH_PROJ_PAGE}}

return render(request, 'index.html', context=context)
```

Breaking that down:

1) 
```python 
auth_url = OpenHumansMember.get_auth_url()
context = {**context, **{'auth_url': auth_url,
                         'oh_proj_page': settings.OH_PROJ_PAGE}}
```
This gets the auth url which is automatically generated by the ‘django-open-humans’ and the project page url. We can also store page related data in here such as ‘stepper_data’.
 
2)
```python
if request.user.is_authenticated:
    oh_member = request.user.openhumansmember
    context = {**context, **{'oh_id': oh_member.oh_id,
                             'oh_member': oh_member,
                             'oh_proj_page': settings.OH_PROJ_PAGE}}

```

This firstly ensure that the user is authenticated, and then sets `oh_member` to the logged in open humans member object. 

Finally we use the `**` notation in python. `**` unpacks the dictionary that it proceeds (As per the PEP-8 style guide - [PEP 448 — Additional Unpacking Generalizations | Python.org](https://www.python.org/dev/peps/pep-0448/)).  In this case we are creating a dictionary, and inside that dictionary providing two sub-dictionaries which are to be unpacked. This results in a single dictionary containing all the keys from both sub-dictionaries. (_It effectively allows merging of unique dictionaries_)

Using this we can append the additional context. In this case, the specific object for the member that is logged in. 


## Proposed Data Structures:
### File Body:
```json
    {
        "UID": "0000001",
        "EID": "32097868",
        "date": "18/09/19",
        "Event_What": "The air conditioning in the room where I was having a meeting was really loud and I found it really heard to concentrate, it was a rubbish experience.",
        "Location_Where": "NW1 2HS",
        "LikeToBeDifferent": "I would have liked the air conditioning to less loud to aid my concentration",
        "Summary": "Loud Air Conditioning"
```

### Metadata
```json
		}
		  "public": false,
		  "approved": true,
		  "research_opt_in": true
    }
```

#### Public Flag:
The public boolean flag, is used to filter posts which can be displayed publicly.

#### Approved Flag:
This flag is used to filter posts which have been approved by a moderator. This will only show if the public flag is set to true.

The approved flag enables moderators to view a list of unapproved uploads and approve for public viewing or reject.

#### Research Flag:
This flag enables filtering by posts that the user wishes to include/exclude from the associated research project.

## Uploading files
_TBC_

## Adding Metadata
_TBC_
